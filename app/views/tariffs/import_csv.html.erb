<br/>
<%= raw link_nice_tariff(@tariff).html_safe %>


<% if @step == 1 %>

    <br/>
    <%= _('Tariff_import_step_1_1') %>:
    <br/>
    <br/>

    <%= form_tag({:action => 'import_csv', :step => "2"}, {:multipart => "true", :id => "files"}) do %>

        <!--
        <%= check_box_tag 'can_overwrite_rates', "1", true %> <%= _('Can_overwrite_rates') %> <br />
    <%= check_box_tag 'can_create_destinations', "1", true %> <%= _('Can_create_destinations') %> <br />
    <%= check_box_tag 'use_lata_ocn_npanxx', "1", false %> <%= _('Use_LATA_OCN_NPANXX') %> <br /><br />
    -->

        <%= _('Upload') %>: <%= file_field_tag "file" %>

        <%= submit_tag(_('Upload_file'), :disable_with => _('Processing..')) %>
    <% end %>

    <br/>
    <%= _('Next_step') + ": " + _('Column_assignment') %>

<% end %>

<% if @step == 2 %>
    <%= render :partial => "import_csv_step_2" %>
<% end %>

<% if @step == 3 %>
    <%= render :partial => "import_csv_step_3" %>
<% end %>

<% if @step == 4 %>
    <%= render :partial => 'import_csv_analysis' %>

    <br/>
    <table>
      <tr>
        <td>
          <%= form_tag({:action => 'import_csv', :step => "5"}) do %>

              <%= submit_tag(_('Proceed'), :disable_with => _('Processing..')) %>
          <% end %>
        </td>
      </tr>
    </table>
    <br/>
    <% unless reseller? %>
        <%= _('Next_step') + ": " + _('Creating_destinations') %>
    <% else %>
        <%= _('Next_step') + ": " + _('Updating_rates') %>
    <% end %>
<% end %>

<% if @step == 5 %>

    <%= render :partial => 'import_csv_analysis' %>

    <br/>
    <br/><br/>
    <b><%= _('Results') %></b>
    <table class="maintable" width="50%">
      <tr class="row1">
        <td id="created_destinations" width="50%"><%= _('Created_destinations') %></td>
        <td id="number_of_cr_dest" align="right" width="15%"><b><%= session[:created_destinations] %> </b></td>
      </tr>

      <% if session[:imp_update_dest_names].to_i == 1 %>
          <tr class="row2">
            <td id="updated_destinations" width="50%"><%= _('Destination_names_updated') %></td>
            <td id="number_of_up_dest" align="right" width="15%"><b><%= session[:updated_destinations].to_i %> </b></td>
          </tr>
      <% end %>
    </table>
    <br/><br/>
    <table>
      <tr>
        <td>
          <%= form_tag({:action => 'import_csv', :step => "6"}) do %>
              <%= submit_tag(_('Proceed'), :disable_with => _('Processing..')) %>
          <% end %>
        </td>
      </tr>
    </table>
    <br/>
    <%= _('Next_step') + ": " + _('Updating_rates') %>
<% end %>


<% if @step == 6 %>

    <%= render :partial => 'import_csv_analysis' %>
    <br/>

    <br/><br/>
    <b><%= _('Results') %></b>
    <table class="maintable" width="50%">
      <% unless reseller? %>
          <tr class="row1">
            <td id="c_dest" width="50%"> <%= _('Created_destinations') %> </td>
            <td id="number_of_c_dest" align="right" width="15%"><b><%= session[:created_destinations] %></b></td>
          </tr>
      <% end %>
      <tr>
        <td id="updated_rates">                <%= _('Rates_updated') %> </td>
        <td id="number_of_up_rates" align="right"><b><%= session[:updated_rates] %></b></td>
      </tr>
    </table>
    <br/><br/>

    <table>
      <tr>
        <td>
          <%= form_tag({:action => 'import_csv', :step => "7"}) do %>
              <%= submit_tag(_('Proceed'), :disable_with => _('Processing..')) %>
          <% end %>
        </td>
      </tr>
    </table>
    <br/>
    <%= _('Next_step') + ": " + _('Creating_new_rates') %>
<% end %>


<% if @step == 7 %>

    <%= render :partial => 'import_csv_analysis' %>
    <br/>

    <br/><br/>
    <b><%= _('Results') %></b>
    <table class="maintable" width="50%">
      <% unless reseller? %>
          <tr class="row1">
            <td id="c_dest" width="50%"> <%= _('Created_destinations') %> </td>
            <td id="nr_of_c_dest" align="right" width="15%"><b><%= session[:created_destinations] %></b></td>
          </tr>
      <% end %>
      <tr>
        <td id="rates">                <%= _('Rates_updated') %> </td>
        <td id="up_rates" align="right"><b><%= session[:updated_rates] %></b></td>
      </tr>
      <tr class="row1">
        <td id="new_rates">                <%= _('New_rates_created') %> </td>
        <td id="nr_of_new_rates" align="right"><b><%= session[:created_new_rates] %></b></td>
      </tr>
    </table>
    <br/><br/>
    <b><%= _('Congratulations_csv_import') %>!</b>

    <% if session[:created_destinations].to_i > 1 and !reseller? %>
        <br/><br/>
        <b><%= b_exclamation + _('Destinations_without_Destination_Groups') %>
          : <%= link_to b_fix + _('Fix'), :controller => "destination_groups", :action => "destinations_to_dg" %></b>
    <% end %>

    <br/><br/><br/>
    <%= link_to b_back + _('Back_to_tariffs'), :action => 'list' %>
<% end %>











<% if @step == 20 %>

    <%= _('File_size') %>: <%= @file_size %> <%= _('bytes') %><br />
    <%= _('File_lines') %>: <%= @file_lines %> <br/><br/>

    <%= _('Can_overwrite_rates') %>:
    <%= if @can_overwrite_rates
          b_check
        else
          b_cross
        end %> <br/>
    <%= _('Can_create_destinations') %>:
    <%= if @can_create_destinations
          b_check
        else
          b_cross
        end %> <br/>
    <%= _('Use_LATA_OCN_NPANXX') %>:
    <%= if @use_lata_ocn_npanxx
          b_check
        else
          b_cross
        end %> <br/><br/>

    <%= _('Total_directions') %>: <%= @total_directions %> <br/>
    <%= _('Total_destinations') %>: <%= @total_destinations %> <br/>
    <%= _('Total_rates_for_tariff') %>: <%= @total_tariff_rates %> <br/>

    <br/>

    <% if not @use_lata_ocn_npanxx %>
        <table class="maintable" width="100%">
          <tr>
            <th align="left"><%= _('Prefix') %></th>
            <th align="left"><%= _('Rate') %></th>
            <th align="left"><%= _('Increment') %></th>
            <th align="left"><%= _('Min_time') %></th>
            <th align="right"><%= _('Country_code') %></th>
            <th align="right"><%= _('Destination') %></th>
            <th align="right"><%= _('Status') %></th>
          </tr>
          <% for i in 0..@file_lines %>
              <% rc = "row" + (i % 2 + 1).to_s
                 rc = "yellow" if @status[i] > 0
                 rc = "red" if @status[i] > 9
              %>

              <tr class=<%= rc %>>
                <td>  <%= @prefix[i] %> </td>
                <td>  <%= @rate[i] %> </td>
                <td>  <%= @increment[i] %> </td>
                <td>  <%= @min_time[i] %> </td>
                <td align="right">  <%= @country_code[i] %> </td>
                <td align="right">  <%= @destination[i] %> </td>
                <td align="right">  <%= @status[i] %> </td>
              </tr>
          <% end %>
        </table>
    <% else %>

        <table class="maintable" width="100%">
          <tr>
            <th align="left"><%= _('NPANXX') %></th>
            <th align="left"><%= _('City') %></th>
            <th align="left"><%= _('State') %></th>
            <th align="left"><%= _('LATA') %></th>
            <th align="right"><%= _('Class') %></th>
            <th align="right"><%= _('OCN') %></th>
            <th align="right"><%= _('Rate') %></th>
            <th align="right"><%= _('OCN_Name') %></th>
          </tr>
          <%
             for_end = @file_lines
             for_end = 100 if @file_lines > 100
          %>
          <% for i in 0..for_end %>
              <% rc = "row" + (i % 2 + 1).to_s
                 rc = "yellow" if @status[i] > 0
                 rc = "red" if @status[i] > 9
              %>

              <tr class=<%= rc %>>
                <td>  <%= @prefix[i] %> </td>
                <td>  <%= @city[i] %> </td>
                <td>  <%= @state[i] %> </td>
                <td>  <%= @lata[i] %> </td>
                <td align="right">  <%= @tier[i] %> </td>
                <td align="right">  <%= @ocn[i] %> </td>
                <td align="right">  <%= @rate[i] %> </td>
                <td align="right">  <%= @name[i] %> </td>
              </tr>
          <% end %>
        </table>

    <% end %>

    <br/><br/>
    <% if @can_import %>
        <b><%= b_check + _('File_imported') %></b><br/><br/>
        <%= _('New_destinations') %>: <%= @new_destinations %> <br/>
        <%= _('Changed_rates') %>: <%= @changed_rates %> <br/>
        <%= _('New_rates') %>: <%= @new_rates %> <br/>
    <% else %>
        <b><%= b_cross + _('File_not_imported') %></b>
    <% end %>

<% end %>
<br/>
<br/>
<% link_to _('Rate_import_status'), {:action => "rate_import_status"}, :popup => ['new_window', 'height=300,width=600'] %>